
<div class="layout">

  <!-- Sidebar -->
  <aside class="sidebar">
    <h2 class="sidebar-title">Manager</h2>

    <ul class="menu">
      <li [class.active]="section === 'create-budget'" (click)="setSection('create-budget')">
        Create Budget
      </li>
      <li [class.active]="section === 'view-budgets'" (click)="setSection('view-budgets')">
        Budgets
      </li>
      <li [class.active]="section === 'approvals'" (click)="setSection('approvals')">
        Approvals
      </li>
      <li [class.active]="section === 'notifications'" (click)="setSection('notifications')">
        Notifications
      </li>
      <li (click)="logout()">
        Logout
      </li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main">

    <header class="navbar">
      <div class="navbar-left">
        <h3>Manager Dashboard</h3>
        <p class="navbar-subtitle">Manage budgets and approvals for your team</p>
      </div>
      <div class="navbar-right">
        <div class="navbar-meta">
          <span>Total Budgets: {{ totalBudgetsCount }}</span>
          <span>Total Allocated: {{ totalAllocatedAmount | currency }}</span>
          <span>Total Spent: {{ totalSpentAmount | currency }}</span>
          <span>Over Budget: {{ overBudgetCount }}</span>
          <span>Pending Expenses: {{ pendingExpensesCount }}</span>
        </div>
        <div class="profile-wrapper">
          <button type="button" class="profile-chip" (click)="toggleProfileMenu()">
            <div class="profile-initials">
              {{ userName.charAt(0) | uppercase }}
            </div>
            <div class="profile-text">
              <span class="profile-label">Welcome</span>
              <span class="profile-name">{{ userName }}</span>
            </div>
          </button>
          <div class="profile-menu" *ngIf="showProfileMenu">
            <button type="button" (click)="navigateToProfile()">View Profile</button>
            <button type="button" (click)="logout()">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <div class="content">

      <!-- Overview cards -->
      <section class="summary-grid">
        <div class="summary-card">
          <h4>Total Budgets</h4>
          <p class="summary-value">{{ totalBudgetsCount }}</p>
        </div>
        <div class="summary-card">
          <h4>Total Allocated</h4>
          <p class="summary-value">{{ totalAllocatedAmount | currency }}</p>
        </div>
        <div class="summary-card">
          <h4>Total Spent</h4>
          <p class="summary-value">{{ totalSpentAmount | currency }}</p>
        </div>
        <div class="summary-card">
          <h4>Over Budget</h4>
          <p class="summary-value">{{ overBudgetCount }}</p>
        </div>
      </section>

      <!-- Create Budget Page -->
      <section *ngIf="section === 'create-budget'" class="card">
        <h4>Create Budget</h4>

        <form [formGroup]="budgetForm" (ngSubmit)="createBudget()" class="form-grid">
          <div class="form-group">
            <label>Title</label>
            <input type="text" formControlName="title" placeholder="e.g. Q2 Marketing Budget" />
            <div class="error" *ngIf="f['title'].invalid && (f['title'].touched || f['title'].dirty)">
              Title is required (max 100 characters).
            </div>
          </div>

          <div class="form-group">
            <label>Amount Allocated</label>
            <input type="number" formControlName="amountAllocated" placeholder="e.g. 50000" />
            <div class="error" *ngIf="f['amountAllocated'].invalid && (f['amountAllocated'].touched || f['amountAllocated'].dirty)">
              Please enter a positive amount.
            </div>
          </div>

          <div class="form-group">
            <label>Department</label>
            <select formControlName="departmentId">
              <option value="">Select department</option>
              <option *ngFor="let dept of departments" [value]="dept.departmentId">
                {{ dept.departmentName }}
              </option>
            </select>
            <div class="error" *ngIf="f['departmentId'].invalid && (f['departmentId'].touched || f['departmentId'].dirty)">
              Please select a department.
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="primary-btn">
              Create Budget
            </button>
          </div>
        </form>
      </section>

      <!-- View Budgets + Expense Approvals -->
      <section *ngIf="section === 'view-budgets'" class="two-column">

        <!-- Budgets Table -->
        <div class="card">
          <div class="card-header">
            <h4>Budgets</h4>
          </div>

          <div *ngIf="isLoadingBudgets">Loading budgets...</div>

          <table *ngIf="!isLoadingBudgets && budgets.length" class="table">
            <thead>
              <tr>
                <th>Title</th>
                <th>Amount</th>
                <th>Department</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let b of budgets">
                <td>{{ b.title }}</td>
                <td>{{ b.amountAllocated | currency }}</td>
                <td>{{ b.departmentId }}</td>
                <td class="actions">
                  <button type="button" class="link-btn" (click)="openEditModal(b)">View / Update</button>
                  <button type="button" class="danger-btn" (click)="deleteBudget(b.id)">Delete</button>
                </td>
              </tr>
            </tbody>
          </table>

          <div *ngIf="!isLoadingBudgets && !budgets.length" class="empty-state">
            No budgets created yet.
          </div>
        </div>
      </section>

      <!-- Approvals Tab -->
      <section *ngIf="section === 'approvals'" class="card">
        <div class="card-header">
          <h4>Expense Approvals</h4>
        </div>

        <div *ngIf="isLoadingExpenses">Loading expenses...</div>

        <table *ngIf="!isLoadingExpenses && managerExpenses.length" class="table">
          <thead>
            <tr>
              <th>Expense Title</th>
              <th>Amount</th>
              <th>Employee</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let e of managerExpenses">
              <td>{{ e.title }}</td>
              <td>{{ e.amount | currency }}</td>
              <td>{{ e.employeeName || '-' }}</td>
              <td>
                <span class="badge" [ngClass]="{
                  'badge-pending': e.status === 'Pending',
                  'badge-approved': e.status === 'Approved',
                  'badge-rejected': e.status === 'Rejected'
                }">
                  {{ e.status }}
                </span>
              </td>
              <td class="actions">
                <button
                  type="button"
                  class="primary-btn"
                  (click)="approveExpense(e)"
                  [disabled]="e.status === 'Approved'">
                  Approve
                </button>
                <button
                  type="button"
                  class="danger-outline-btn"
                  (click)="rejectExpense(e)"
                  [disabled]="e.status === 'Rejected'">
                  Reject
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="!isLoadingExpenses && !managerExpenses.length" class="empty-state">
          No expenses assigned to you yet.
        </div>
      </section>

      <!-- Notifications -->
      <section *ngIf="section === 'notifications'" class="card">
        <h4>Notifications</h4>

        <div *ngIf="!notifications.length" class="empty-state">
          No notifications yet. Actions on budgets and expenses will appear here.
        </div>

        <ul *ngIf="notifications.length" class="notification-list">
          <li *ngFor="let n of notifications">
            <div class="notification-pill" [ngClass]="{
              'notif-expense': n.type === 'expense',
              'notif-budget': n.type === 'budget'
            }">
              <span class="notif-type">
                {{ n.type === 'expense' ? 'Expense' : 'Budget' }}
              </span>
              <span class="notif-message">{{ n.message }}</span>
              <span class="notif-time">{{ n.createdAt | date:'shortTime' }}</span>
            </div>
          </li>
        </ul>
      </section>

    </div>
  </div>

  <!-- Edit Budget Modal -->
  <div class="modal-backdrop" *ngIf="showEditModal">
    <div class="modal">
      <h4>Edit Budget</h4>

      <form [formGroup]="editBudgetForm" (ngSubmit)="updateBudget()" class="form-grid">
        <div class="form-group">
          <label>Title</label>
          <input type="text" formControlName="title" />
        </div>

        <div class="form-group">
          <label>Amount Allocated</label>
          <input type="number" formControlName="amountAllocated" />
        </div>

        <div class="form-group">
          <label>Department</label>
          <select formControlName="departmentId">
            <option value="">Select department</option>
            <option *ngFor="let dept of departments" [value]="dept.departmentId">
              {{ dept.departmentName }}
            </option>
          </select>
        </div>

        <div class="form-actions modal-actions">
          <button type="button" class="secondary-btn" (click)="closeEditModal()">Cancel</button>
          <button type="submit" class="primary-btn">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

</div>